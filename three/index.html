<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Three</title>

    <style>
        html, body { margin: 0; padding: 0; }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
    <script src="js/orbit.js"></script>
    <script src="js/T.js"></script>
    <script src="js/floors.js"></script>
    <script src="js/forms.js"></script>

    <script type="x-shader/x-vertex" id="vertexShader">

		varying vec3 vWorldPosition;

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}

	</script>

	<script type="x-shader/x-fragment" id="fragmentShader">

		uniform vec3 topColor;
		uniform vec3 bottomColor;
		uniform float offset;
		uniform float exponent;

		varying vec3 vWorldPosition;

		void main() {

			float h = normalize( vWorldPosition + offset ).y;
			gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );

		}

	</script>
</head>
<body>
    <div id="container"></div>
    <script>

        (function(){

            var world, camera, controls, scene, renderer;

            init();
            render();

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
            }

            function init() {

                world = new T();

                camera = world.camera;
                //camera.x(200).y(750).z(200).
                camera.position.x = -1000;
                camera.position.y = 750;
                camera.position.z = 500;

                scene = world.scene;

                renderer = world.renderer;
                renderer.setClearColor('#f2e8e8');

                controls = new THREE.OrbitControls( camera, renderer.domElement );
                controls.damping = 0.5;
    			controls.addEventListener( 'change', render );

                var floorOffset = 0;
                var floorMaterial = new THREE.MeshLambertMaterial({
                    color: '#ddd'
                });

                floors.forEach(function(floor, i) {

                    var floorPlan = new THREE.Shape(),
                        floorGeo,
                        floorMesh;

                    // start it up
                    floorPlan.moveTo(floor.vertices[0][0], floor.vertices[0][1]);

                    floor.vertices.forEach(function(pt, j) {

                        if ( j > 0 ) floorPlan.lineTo(pt[0], pt[1]);

                    });

                    // close it off
                    floorPlan.lineTo(floor.vertices[0][0], floor.vertices[0][1]);

                    floorGeo = new THREE.ExtrudeGeometry(floorPlan, {
                        amount: floor.height,
                        bevelSegments: 0
                    });

                    if ( i > 0 ) floorOffset += floors[i - 1].height;

                    floorMesh = world.mesh(floorGeo, floorMaterial);

                    floorMesh.rotation.x = -Math.PI / 2;
                    floorMesh.position.y = floorOffset - 1;
                });


                // Other building 1
                var building1 = [],
                    building1ExtensionHeight = 200;

                // short 'n' squat
                var building1Coords = {
                    x: 300,
                    z: -200
                }
                building1.push(Building.call(world, {
                    width: 200,
                    height: 100,
                    depth: 100,
                    x: building1Coords.x,
                    z: building1Coords.z,
                    color: '#ccc'
                }));
                // tall extension
                building1.push(Building.call(world, {
                    x: building1Coords.x + 50,
                    z: building1Coords.z + 100,
                    width: 100,
                    height: building1ExtensionHeight,
                    depth: 100,
                    color: '#ccc'
                }));
                // cap the tall one off
                var building1Part3 = world.mesh(Box(108, 12, 108), Material('lambert', '#ccc'));
                building1Part3.x(building1Coords.x + 50).y(building1ExtensionHeight + 4).z(building1Coords.z + 100);
                building1.push(building1Part3);

                function rotateAroundYAxis(obj, deg) {

                    var x = obj.position.x,
                        z = obj.position.z,
                        hypotenuse = Math.sqrt(x * x + z * z);

                    var curAngle = Math.atan( x / z ) * 180 / Math.PI,
                        newAngle = curAngle + deg;

                    newAngle = newAngle * Math.PI / 180;

                    obj.position.x = hypotenuse * Math.sin(newAngle);
                    obj.position.z = hypotenuse * Math.cos(newAngle);
                    obj.rotation.y += deg * Math.PI / 180;
                }

                building1.forEach(function(part) {
                    rotateAroundYAxis(part, 210);
                });


                // GROUND PLANE
                var plane = world.mesh(Box(100000, 1, 100000), Material('lambert', '#999')).y(-1);

                var light = world.light();
                light.target = building1[0];
                light.position.set(1000, 2500, 2000);

                var light2 = world.light('#fff', 0.5, false);
                light2.target = building1[0];
                light2.position.set(-2000, 2500, -1000);

                var hemiLight = new THREE.HemisphereLight( '#57f', '#000', 0.15 );

                hemiLight.position.x = -200;
				hemiLight.position.y = 500;
				scene.add( hemiLight );

                // SKYDOME
				var vertexShader = document.getElementById( 'vertexShader' ).textContent,
                    fragmentShader = document.getElementById( 'fragmentShader' ).textContent;

				var uniforms = {
					topColor: 	 { type: "c", value: new THREE.Color( 0x0077ff ) },
					bottomColor: { type: "c", value: new THREE.Color( '#f2e8e8' ) },
					offset:		 { type: "f", value: 400 },
					exponent:	 { type: "f", value: 0.6 }
				}
				uniforms.topColor.value.copy( hemiLight.color );

                scene.fog = new THREE.Fog( 0xffffff, 1000, 20000 );
				scene.fog.color.copy( uniforms.bottomColor.value );

				var skyGeo = new THREE.SphereGeometry( 20000, 32, 15 );
				var skyMat = new THREE.ShaderMaterial( {
					uniforms: uniforms,
					vertexShader: vertexShader,
					fragmentShader: fragmentShader,
					side: THREE.BackSide
				} );

				var sky = new THREE.Mesh( skyGeo, skyMat );
				scene.add( sky );

                // ----- resize
                window.addEventListener( 'resize', onWindowResize, false );

                // ----- animate
                animate();
            }

            function render() {
                renderer.render(scene, camera);
            }

            function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();
			}

            function uploadSnapshot() {
                var url = 'http://gentle-stream-4461.herokuapp.com/upload/',
                    canvas = document.getElementsByTagName('canvas')[0],
                    dataURL = canvas.toDataURL().split(',')[1],
                    xhr = new XMLHttpRequest(),
                    data = JSON.stringify({ image: dataURL });

                xhr.open('POST', url, true);
                xhr.onload = function() {
                    console.log(xhr.responseText);
                };
                xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhr.send(data);
            };

            window.addEventListener('keydown', function(e) {
                if ( e.keyCode === 32 ) uploadSnapshot();
            });

        })();
    </script>
</body>
</html>

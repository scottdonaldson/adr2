<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ADR2</title>

    <style>
        html, body { margin: 0; padding: 0; }
        * {
            box-sizing: border-box;
            position: relative;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            transition: 0.2s opacity;
        }

        .faded {
            opacity: 0;
        }

        #controls {
            background: #fff;
            border-top: 1px solid #999;
            bottom: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            width: 100%;
            padding: 1em;
            position: fixed;
            text-align: center;
        }

        .monospace {
            font-family: Monospace;
            font-size: 1.2em;
            font-weight: bold;
            padding-left: 2em;
        }

        .monospace:first-child {
            padding-left: 0;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
    <script src="js/orbit.js"></script>
    <script src="js/T.js"></script>
    <script src="js/floors.js"></script>
    <script src="js/forms.js"></script>

    <script type="x-shader/x-vertex" id="vertexShader">

		varying vec3 vWorldPosition;

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}

	</script>

	<script type="x-shader/x-fragment" id="fragmentShader">

		uniform vec3 topColor;
		uniform vec3 bottomColor;
		uniform float offset;
		uniform float exponent;

		varying vec3 vWorldPosition;

		void main() {

			float h = normalize( vWorldPosition + offset ).y;
			gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );

		}

	</script>
</head>
<body>
    <div id="container"></div>
    <div id="controls">
        <span class="monospace">Left Mouse</span>&nbsp;-&nbsp;Orbit
        <span class="monospace">Right Mouse</span>&nbsp;-&nbsp;Pan
        <span class="monospace">Enter</span>&nbsp;-&nbsp;Take Screenshot
        <span class="monospace">Space Bar</span>&nbsp;-&nbsp;Time Goes By
    </div>
    <script>

        (function(){

            var world, camera, controls, scene, renderer;

            // going to increment this
            var light, lightTarget;

            init();
            render();

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
            }

            function init() {

                world = new T('container');

                camera = world.camera;
                camera.position.x = -1000;
                camera.position.y = 750;
                camera.position.z = 500;

                scene = world.scene;

                renderer = world.renderer;
                renderer.setClearColor('#f2e8e8');

                controls = new THREE.OrbitControls( camera, renderer.domElement );
                controls.damping = 0.5;
    			controls.addEventListener( 'change', render );

                var floorOffset = 0;

                floors.forEach(function(floor, i) {

                    var floorPlan = new THREE.Shape(),
                        floorHole,
                        floorGeo,
                        floorMesh;

                    // start it up
                    floorPlan.moveTo(floor.vertices[0][0], floor.vertices[0][1]);

                    floor.vertices.forEach(function(pt, j) {

                        if ( j > 0 ) floorPlan.lineTo(pt[0], pt[1]);

                    });

                    // close it off
                    floorPlan.lineTo(floor.vertices[0][0], floor.vertices[0][1]);

                    if ( floor.hole ) {
                        floor.hole.forEach(function(pt, j) {
                            floor.hole[j] = new THREE.Vector2(pt[0], pt[1]);
                        });

                        floorHole = new THREE.Path(floor.hole);

                        floorPlan.holes.push(floorHole);
                    }

                    floorGeo = new THREE.ExtrudeGeometry(floorPlan, {
                        amount: floor.height,
                        bevelSegments: 0
                    });

                    if ( i > 0 ) floorOffset += floors[i - 1].height;

                    floorMesh = world.mesh(floorGeo, new THREE.MeshLambertMaterial({
                        color: '#ddd'
                    }));

                    floorMesh.rotation.x = -Math.PI / 2;
                    floorMesh.position.y = floorOffset - 1;
                });

                function rotateAroundYAxis(obj, deg) {

                    var x = obj.position.x,
                        z = obj.position.z,
                        hypotenuse = Math.sqrt(x * x + z * z);

                    var curAngle = Math.atan( x / z ) * 180 / Math.PI,
                        newAngle = curAngle + deg;

                    newAngle = newAngle * Math.PI / 180;

                    obj.position.x = hypotenuse * Math.sin(newAngle);
                    obj.position.z = hypotenuse * Math.cos(newAngle);
                    obj.rotation.y += deg * Math.PI / 180;
                }

                // Tall building
                var building1 = [],
                    building1Height = 400;

                building1.push(Building.call(world, {
                    width: 200,
                    height: building1Height,
                    depth: 100,
                    x: 300,
                    z: -200,
                    color: '#ccc'
                }));

                building1.forEach(function(part) {
                    rotateAroundYAxis(part, 210);
                });

                var citibank = Building.call(world, {
                    width: 150,
                    height: 550,
                    depth: 150,
                    color: '#ccf',
                    x: -400,
                    z: -200
                });
                for ( var topper = 0; topper < 5; topper++ ) {
                    world.mesh(
                        Box(150 - (topper + 1) * 20, 15, 150 - (topper + 1) * 20),
                        Material('#bbe')
                    ).x(-400).y(550 + 7.5 + topper * 15).z(-200).exclude = true;
                }
                lightTarget = citibank;

                var cunyFootprint = new THREE.Shape();
                cunyFootprint.moveTo(100, 100);
                cunyFootprint.bezierCurveTo(
                    100, 10,
                    10, 0,
                    0, 0
                );
                cunyFootprint.lineTo(-20, 0);
                cunyFootprint.lineTo(-20, 100);
                cunyFootprint.lineTo(100, 100);
                var cunyGeo = new THREE.ExtrudeGeometry(cunyFootprint, {
                    amount: 120,
                    bevelSegments: 0
                });
                var cuny = world.mesh(cunyGeo, Material('#aab'));
                cuny.exclude = true;
                cuny.rotation.x = -Math.PI / 2;
                cuny.position.x = -200;
                cuny.position.z = -200;
                cuny.position.y = -1;

                var cuny2 = world.mesh(cunyGeo, Material('#aab'));
                cuny2.exclude = true;
                cuny2.scale.x = 0.75;
                cuny2.scale.y = 0.75;
                cuny2.scale.z = 0.5;
                cuny2.rotation.x = -Math.PI / 2;
                cuny2.position.x = -206;
                cuny2.position.z = -226;
                cuny2.position.y = 119;


                // Group of neighboring buildings
                var neighbor = [],
                    building2Material = Material('#b97'),
                    building2_1 = world.mesh(
                        Box(60, 30, 20),
                        building2Material
                    ).x(140),
                    building2_2 = world.mesh(
                        Box(20, 30, 40),
                        building2Material
                    ).x(160).z(-30),
                    building2_3 = world.mesh(
                        Box(40, 15, 40),
                        Material('#666')
                    ).x(130).z(-30);
                neighbor.push(building2_1);
                neighbor.push(building2_2);
                neighbor.push(building2_3);

                function shapeFromPlan(plan) {
                    var thePlan = new THREE.Shape();
                    // start it up
                    thePlan.moveTo(plan[0][0], plan[0][1]);
                    plan.forEach(function(pt, j) {

                        if ( j > 0 ) thePlan.lineTo(pt[0], pt[1]);

                    });
                    // close it off
                    thePlan.lineTo(plan[0][0], plan[0][1]);
                    return thePlan;
                }

                var building3plan = [
                    [0, 0],
                    [25, 0],
                    [25, 40],
                    [0, 30]
                ];
                var building3 = world.mesh(
                        new THREE.ExtrudeGeometry(shapeFromPlan(building3plan), {
                            amount: 25,
                            bevelSegments: 0
                        }),
                        Material('#943')
                    ),
                    building3Roof = world.mesh(
                        new THREE.ExtrudeGeometry(shapeFromPlan(building3plan), {
                            amount: 2,
                            bevelSegments: 0
                        }),
                        Material('#eee')
                    );
                building3.position.x = 100;
                building3Roof.position.x = 100;
                building3.position.z = -60;
                building3Roof.position.z = -60;
                building3.rotation.x = -Math.PI / 2;
                building3Roof.rotation.x = -Math.PI / 2;
                building3.position.y = 0;
                building3Roof.position.y = 24;

                neighbor.push(building3);
                neighbor.push(building3Roof);

                neighbor.forEach(function(obj) {
                    obj.position.y -= 1;
                    obj.exclude = true;
                });

                // GROUND PLANE
                var plane = world.mesh(Box(100000, 1, 100000), Material('lambert', '#777')).y(-1);
                plane.exclude = true;

                light = world.light();
                light.target = lightTarget;
                var lightX = -500,
                    lightY = 2500,
                    lightZ = 2000;
                light.position.set(lightX, lightY, lightZ);

                var light2 = world.light('#fff', 0.5, false);
                light2.target = lightTarget;
                light2.position.set(-2000, 2500, -1000);

                var hemiLight = new THREE.HemisphereLight( '#57f', '#000', 0.15 );

                hemiLight.position.x = -200;
				hemiLight.position.y = 500;
				scene.add( hemiLight );

                // SKYDOME
				var vertexShader = document.getElementById( 'vertexShader' ).textContent,
                    fragmentShader = document.getElementById( 'fragmentShader' ).textContent;

				var uniforms = {
					topColor: 	 { type: "c", value: new THREE.Color( 0x0077ff ) },
					bottomColor: { type: "c", value: new THREE.Color( '#f2e8e8' ) },
					offset:		 { type: "f", value: 400 },
					exponent:	 { type: "f", value: 0.6 }
				}
				uniforms.topColor.value.copy( hemiLight.color );

                scene.fog = new THREE.Fog( 0xffffff, 1000, 20000 );
				scene.fog.color.copy( uniforms.bottomColor.value );

				var skyGeo = new THREE.SphereGeometry( 20000, 32, 15 );
				var skyMat = new THREE.ShaderMaterial( {
					uniforms: uniforms,
					vertexShader: vertexShader,
					fragmentShader: fragmentShader,
					side: THREE.BackSide
				} );

				var sky = new THREE.Mesh( skyGeo, skyMat );
				scene.add( sky );

                // ----- resize
                window.addEventListener( 'resize', onWindowResize, false );

                // ----- animate
                animate();
            }

            var raycaster = new THREE.Raycaster(),
                mouse = new THREE.Vector2();

            var intersects = [];

            function render() {

                if ( raycaster ) {
                    raycaster.setFromCamera( mouse, camera );

                    intersects.forEach(function(intersect) {
                        if ( intersect.object && intersect.object.oldColor ) {
                            intersect.object.material.color = intersect.object.oldColor;
                        }
                    });
                    intersects = [];

                    // calculate objects intersecting the picking ray
                    raycaster.intersectObjects( scene.children ).forEach(function(intersect) {
                        intersects.push(intersect);
                    });

                    var closest = Infinity,
                        closestObj;
                    intersects.forEach(function(intersect) {
                        if ( intersect.distance < closest ) {
                            closest = intersect.distance;
                            closestObj = intersect;
                        }
                    });

                    var hypotenuse = Math.sqrt(camera.x() * camera.x() + camera.z() * camera.z());

                    if ( !closestObj.object.exclude ) {

                        var oldColor;
                        if ( closestObj.object && !closestObj.object.exclude ) {
                            oldColor = closestObj.object.oldColor || closestObj.object.material.color;
                            if ( oldColor ) {
                                closestObj.object.oldColor = oldColor;
                                closestObj.object.material.color = new THREE.Color( 0.666 * (1 + oldColor.r), 0.666 * (1 + oldColor.g), 0.666 * (1 + oldColor.b) );
                            }
                        }

                        closestObj.object.position.x -= camera.x() / hypotenuse;
                        closestObj.object.position.z -= camera.z() / hypotenuse;
                    }
                }

                renderer.render(scene, camera);
            }

            function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();
			}

            function uploadSnapshot() {
                var canvas = document.getElementsByTagName('canvas')[0];

                var url = 'http://gentle-stream-4461.herokuapp.com/upload/',
                    canvas = document.getElementsByTagName('canvas')[0],
                    dataURL = canvas.toDataURL().split(',')[1],
                    xhr = new XMLHttpRequest(),
                    data = JSON.stringify({ image: dataURL });

                xhr.open('POST', url, true);
                xhr.onload = function() {
                    console.log(xhr.responseText);
                };
                xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhr.send(data);

                canvas.classList.add('faded');
                setTimeout(function(){
                    canvas.classList.remove('faded');
                }, 350);
            };

            function timeGoesBy() {
                light.position.z -= 25;
                light.position.set(light.position.x, light.position.y, light.position.z);
                light.target = lightTarget;
                render();
            }

            window.addEventListener('keydown', function(e) {
                // enter
                if ( e.keyCode === 13 ) uploadSnapshot();
                // space bar
                if ( e.keyCode === 32 ) timeGoesBy();
            });



            // ----- RAYCASTER

            function onMouseMove( event ) {

            	// calculate mouse position in normalized device coordinates
            	// (-1 to +1) for both components

            	mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1
            	mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1

                if ( raycaster ) {

                }

                render();
            }

            window.addEventListener( 'mousemove', onMouseMove, false );

            window.requestAnimationFrame(render);

        })();
    </script>
</body>
</html>
